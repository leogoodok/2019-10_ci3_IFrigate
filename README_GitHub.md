# ci3.wotskill.ru - GitHub репозиторий фреймворка CodeIgniter v3.1.11

## Подготовка CodeIgniter к использованию

### Установка дополнений

1. Пакет Русского языка
  - Скачать дополнение с "https://github.com/bcit-ci/codeigniter3-translations"
  - Скопировать из архива папку с нужным языком (russian).
  - Разместить в "~\system\language\russian\"


### Создание приложения CI3 для FRONTEND части сайта

#### Перенос файлов Фреймворка из WEB доступной директории

1. Создание WEB доступной директории "~\docs"

2. Перемещение "Входного скрипта" (index.php) в WEB доступную директорию
  - новый путь:
```
  "~\docs\index.php"
```

3. Настройки путей к папкам Фреймворка в файле "~\docs\index.php".
  - Новый путь к папке SYSTEM:
```
$system_path = realpath(__DIR__.'/../system');
```
  - Новый путь к папке APPLICATION:
```
$application_folder = realpath(__DIR__.'/../application');
```

4. Добавление файла, с правилами переадресации, для скрытия из URL входного скрипта
```
~\docs\.htaccess
```

5. ! Внимание ! Перед публикацией (размещением) приложения на хостинге (сервере) переключить его в режим "production".
```
// define('ENVIRONMENT', isset($_SERVER['CI_ENV']) ? $_SERVER['CI_ENV'] : 'development');
define('ENVIRONMENT', 'production');
```

6. Примечание. Можно удалить файлы "index.html" из всех директорий Приложения, так как доступ из WEB к этим папкам теперь невозможен.

#### Настройка Фреймворка

1. Редактирование файла конфигурации "~\application\config\config.php".
  - Установка базового URL сайта.
```
$protocol = isset($_SERVER['HTTPS']) && ($_SERVER['HTTPS'] === 'on' || $_SERVER['HTTPS'] === 1) || isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https' ? 'https' : 'http';
$path = '';
$config['base_url'] = "$protocol://{$_SERVER['HTTP_HOST']}/$path";
unset($protocol,$path);
```
  - Не обязательно. Удаление префикса пользовательских классов. Использовать пространства имен!
```
$config['subclass_prefix'] = '';
```
  - Установка ключа шифрования.
```
$config['encryption_key'] = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
```
  - Включение защиты от Подделки межсайтовых запросов
```
$config['csrf_protection'] = TRUE;
```
  - Если отправка формы реализуется средствами JS AJAX: отключить "Регенерировать токен при каждой отправке" и увеличить время действия токена.
```
$config['csrf_expire'] = 2*60*60;
$config['csrf_regenerate'] = FALSE;
```
  - Изменение Языка по умолчанию
```
$config['language'] = 'russian';
```

2. Редактирование настроек подключения к БД в файле "~\application\config\database.php".

3. Настройка автозагрузки библиотек в файле "~\application\config\autoload.php".
```
$autoload['libraries'] = ['session', 'database', 'email'];
```

4. Настройка отправки Email. Создан файл с настройками "~\application\config\email.php"


### Создание второго приложения CI3, для BACKEND части сайта

#### Копирование файлов приложения

1. Создание в папке приложения "~\application\" нового каталога второго приложения.
```
"~\application\admin\"
```
  - Копирование папок (со всем содержимым) из первого приложения "~\application\".
```
~\application\admin\cache
~\application\admin\config
~\application\admin\controllers
~\application\admin\libraries
~\application\admin\logs
~\application\admin\models
~\application\admin\views
```

2. Создание в WEB доступной директории "~\docs\admin\".
  - Копирование в неё файлов из первого приложения "docs".
```
~\docs\admin\index.php
~\docs\admin\.htaccess
~\docs\admin\favicon.ico
```

#### Редактирование входного скрипта приложения

1. Настройки путей к папкам Фреймворка в файле "~\docs\admin\index.php".
  - Путь к папке SYSTEM:
```
$system_path = realpath(__DIR__.'/../../system');
```
  - Путь к папке APPLICATION:
```
$application_folder = realpath(__DIR__.'/../../application/admin');
```

2. ! Внимание ! Перед публикацией (размещением) приложения на хостинге (сервере) не забыть переключить его в режим "production".
```
// define('ENVIRONMENT', isset($_SERVER['CI_ENV']) ? $_SERVER['CI_ENV'] : 'development');
define('ENVIRONMENT', 'production');
```

3. Примечание. Можно удалить файлы "index.html" из всех директорий Приложения, так как доступ из WEB к этим папкам теперь невозможен.

#### Настройка Фреймворка

1. Редактирование файла конфигурации "~\application\admin\config\config.php".
  - Установка базового URL сайта.
```
$protocol = isset($_SERVER['HTTPS']) && ($_SERVER['HTTPS'] === 'on' || $_SERVER['HTTPS'] === 1) || isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https' ? 'https' : 'http';
$path = 'admin/';
$config['base_url'] = "$protocol://{$_SERVER['HTTP_HOST']}/$path";
unset($protocol,$path);
```
  - Не обязательно. Удаление префикса пользовательских классов. Использовать пространства имен!
```
$config['subclass_prefix'] = '';
```
  - Установка ключа шифрования.
```
$config['encryption_key'] = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
```
- Изменение пути сокетов, для устранения конфликтов с FRONTEND частью
```
$config['cookie_path'] = '/'.$path;
```
  - Включение защиты от Подделки межсайтовых запросов
```
$config['csrf_protection'] = TRUE;
```
  - Изменение Языка по умолчанию
```
$config['language'] = 'russian';
```

2. Редактирование настроек подключения к БД в файле "~\application\admin\config\database.php".

3. Настройка автозагрузки библиотек в файле "~\application\admin\config\autoload.php".
```
$autoload['libraries'] = ['session', 'database'];
```


## Создание "FRONTEND" части приложения

### Создание папок для ресурсов и создание/копирование в них файлов
```
~\docs\assets\        - дополнительные ресурсы (js, css, ...)
~\docs\css\           - папка для CSS-файлов
~\docs\css\fonts.css  - подключаемые шрифты
~\docs\css\main.css   - CSS-стили "Основного шаблона страниц сайта"
~\docs\fonts\         - папка для шрифтов
~\docs\js\            - папка для JS-файлов
~\docs\js\main.js     - JS-скрипты "Основного шаблона страниц сайта"
```

### Создание Контроллера "Site"
```
~\application\controllers\Site.php
```
1. Назначение контроллера по умолчанию в файле "~\application\config\routes.php".
```
$route['default_controller'] = 'site';
```

2. Создание Действия "index" выполняет функционал:
  - Получение POST-данных из формы.
  - Валидации входных POST данных.
  - Валидации данных ReCaptcha через Google ReCaptcha API.
  - Сохранение сообщений пользователя в БД.
  - Отправляет сообщение администратору по Email.
  - Рендерит страницу "Отправки сообщения администратору".

3. Создание Действия "ajax" выполняет функционал:
  - Получение POST-данных от JS AJAX.
  - Валидации входных POST данных.
  - Валидации данных ReCaptcha через Google ReCaptcha API.
  - Сохранение сообщений пользователя в БД.
  - Отправляет сообщение администратору по Email.
  - Формирует и отправляет ответ на JS AJAX запрос.

### Создание Класса (Модели) таблицы БД "message"
```
~\application\models\db\TabMessage.php
```

### Создание Класса взаимодействия с API Google ReCaptcha
```
~\application\models\ReCaptcha.php
```

### Создание Представления (Вида)

1. Создание папки шаблонов частей Представлений страниц.
```
~\application\views\layouts\
```

2. Создание Основного шаблона всех страниц сайта.
```
~\application\views\layouts\main.php
```

3. Создание Представления "Отправить сообщение администратору".
```
~\application\views\message.php
```

4. Создание JS скриптов валидации полей формы и JS AJAX отправки формы в файле:
```
~\docs\js\main.js
```


## Создание "BACKEND" части приложения

### Создание папок для ресурсов и создание/копирование в них файлов
```
~\docs\admin\assets\        - дополнительные ресурсы (js, css, ...)
~\docs\admin\css\           - папка для CSS-файлов
~\docs\admin\css\fonts.css  - подключаемые шрифты
~\docs\admin\css\main.css   - CSS-стили "Основного шаблона страниц сайта"
~\docs\admin\js\            - папка для JS-файлов
~\docs\admin\js\main.js     - JS-скрипты "Основного шаблона страниц сайта"
```

### Создание Контроллера "Site"
```
~\application\admin\controllers\Site.php
```
1. Назначение контроллера по умолчанию в файле "~\application\admin\config\routes.php".
```
$route['default_controller'] = 'site';
```

2. Создание Действия "index" - выполняет функционал:
  - Валидации входных POST данных.
  - Запись в БД изменений статуса сообщений пользователей.
  - Удаляет из БД сообщений пользователей.
  - Рендерит страницу "Сообщения администратору".

### Создавать Класс (Модель) таблицы БД "message" не надо, использовать Класс из FRONTEND
```
~\application\models\db\TabMessage.php
```

### Создание Представления (Вида)

1. Создание папки шаблонов частей Представлений страниц.
```
~\application\admin\views\layouts\
```

2. Создание Основного шаблона всех страниц сайта.
```
~\application\admin\views\layouts\main.php
```

3. Создание Представления "Сообщения администратору".
```
~\application\admin\views\message.php
```


## Особенности реализации "FRONTEND" части

1. Отправка сообщений администратору (формы) осуществляется без перезагрузки страницы с использованием JS AJAX методом POST. Перед отправкой формы выполняется проверка (средствами JS) успешной валидации обязательных полей. Обработчик отправки в файле:
```
~\docs\js\main.js
```

2. Контроль и редактирование вводимых пользователем данных. Осуществляется с использованием JS. Обработчики в файле:
```
~\docs\js\main.js
```
  - Поле "Ваше Имя*". Функционал:
```
а) Запрет ввода не разрешенных символов;
б) Удаление более одного "пробела" подряд;
в) Проверка и ограничение максимальной длинны.
```
  - Поле "Email*". Функционал:
```
а) Преобразование вводимых символов с Русской раскладки клавиатуры в Английскую, если пользователь забыл переключить язык ввода;
б) Запрет ввода не разрешенных символов.
```
  - Поле "Тема сообщения*". Функционал:
```
а) Запрет ввода не разрешенных символов;
б) Удаление более одного "пробела" подряд.
```

3. Валидация данных осуществляется двумя способами. Валидация средствами JS выполняется при потере фокуса полем формы. Обработчики в файле:
```
~\docs\js\main.js
```
  - Поле "Ваше Имя*". Функционал и выполняемые действия:
```
I.  Проверка на не пустое поле.
II. Проверка, поле содержит менее минимально допустимого количества символов.

а) Вывод сообщений об ошибке;
в) Изменение CSS классов, для соответствующего оформления поля.
```
- Поле "Email*". Функционал и выполняемые действия:
```
I.  Проверка на не пустое поле.
II. Проверка корректости email. Допустимые форматы:
    - xxx@yyy.zzz
    - xxx@yyy.aaa.zzz
    где:  xxx - обязательная часть, должена содержать 1 и более символов;
          yyy - обязательная часть, должена содержать 1 и более символов;
          aaa - необязательная часть, должена содержать 1-6 символов;
          zzz - обязательная часть, должена содержать 2-6 символов;

а) Вывод сообщений об ошибке;
в) Изменение CSS классов, для соответствующего оформления поля.
```
- Поле "Тема сообщения*". Функционал и выполняемые действия:
```
I.  Проверка на не пустое поле.
II. Проверка, поле содержит менее минимально допустимого количества символов.

а) Вывод сообщений об ошибке;
в) Изменение CSS классов, для соответствующего оформления поля.
```
- Поле "Содержание сообщения*". Функционал и выполняемые действия:
```
I.  Проверка, поле должно содержать хотябы один символ (не пробельный).

а) Вывод сообщений об ошибке;
в) Изменение CSS классов, для соответствующего оформления поля.
```

4. Валидация средствами Фреймворка. В Методе "ajax" Контроллера "site". Размещен в файле:
```
~\application\controllers\Site.php
```
  - Поле "Ваше Имя*". Правила валидации:
```
I.   Обязательное поле.
II.  Не пустое поле.
III. Минимально допустимое количество символов.
IV.  Максимально допустимое количество символов.
```
  - Поле "Email*". Правила валидации:
```
I.   Обязательное поле.
II.  Корректный email.
```
  - Поле "Тема сообщения*". Правила валидации:
```
I.   Обязательное поле.
II.  Не пустое поле.
III. Минимально допустимое количество символов.
```
  - Поле "Содержание сообщения*". Правила валидации:
```
I.   Обязательное поле.
II.  Не пустое поле.
```
  - Поле reCaptcha "Я не робот".
```
Валидация осуществляется запросом в API Google reCaptcha
с использованием класса "ReCaptcha" размещенным в файле:
~\application\models\ReCaptcha.php
```

5. Вывод сообщения о успешной отправке сообщения или ошибках валидации/отправки.





## Особенности реализации "BACKEND" части




...
